# Plan: Timed Home Timeline Sync (Configurable)

## Current Status (from last commit)
- Manual “Sync Home Timeline” button added in `src/components/modals/export-data.tsx`.
- Home timeline sync writes JSONL per-day files via Obsidian Local REST API (`src/utils/obsidian.ts`, `src/utils/sync.ts`).
- Obsidian API base URL + token come from build-time env in `vite.config.ts`.
- Home timeline capture exists but module is disabled by default in options.

## Goals
- Add a timed sync strategy for Home Timeline with a user-configurable on/off switch.
- Keep a single canonical sync path shared by manual and timed sync.
- Be incremental and efficient for long-term use (avoid reprocessing the full DB each run).
- Fail fast on missing config; avoid noisy retries.

## Strategy Overview
- A lightweight scheduler runs in the userscript context while the tab is open.
- Scheduling is gated by a new option toggle and only runs if:
  - HomeTimelineModule is enabled,
  - Obsidian token is configured,
  - no sync is already in flight,
  - optional: page is visible and browser is online.
- Each run syncs only captures since the last successful sync timestamp.

## Change Plan
1) **Options + single source of truth**
   - Add options keys in `src/core/options/manager.ts`:
     - `homeTimelineAutoSyncEnabled` (boolean, default `false`)
     - `homeTimelineAutoSyncIntervalMinutes` (number, default `15`)
     - `homeTimelineLastSyncAt` (number | null, updated on success)
   - Keep defaults centralized with `DEFAULT_APP_OPTIONS`.

2) **Settings UI**
   - Add a “Sync” block to `src/core/settings.tsx` with:
     - Toggle for auto-sync (writes `homeTimelineAutoSyncEnabled`).
     - Interval input (minutes), clamped to a safe range (e.g., 5–180).
     - Read-only “Last sync” display (from `homeTimelineLastSyncAt`).
   - Add i18n keys for the new labels.

3) **Incremental capture query**
   - Extend `DatabaseManager` in `src/core/database/manager.ts` with:
     - `extGetCapturesSince(extName, since)` (query by `created_at` index).
     - `extGetCapturedTweetsSince(extName, since)` (map captures to tweet IDs).
   - Keep this the only source for incremental sync selection.

4) **Unify sync path**
   - Update `syncHomeTimelineToObsidian` in `src/utils/sync.ts` to accept:
     - `tweets?: Tweet[]` or `since?: number` (single canonical entry point).
   - Manual button calls the same function with `since = 0` or no filter.

5) **Scheduler**
   - Add `src/core/sync-manager.ts` (or similar) that:
     - Subscribes to `options.signal` and extension enable/disable changes.
     - Manages one `setInterval` timer based on the configured interval.
     - Guards against concurrent runs (`inFlight`).
     - Updates `homeTimelineLastSyncAt` on success.
   - Start the scheduler from `src/core/app.tsx` (single initialization point).

6) **Runtime safety**
   - Validate inputs up front:
     - If token/base URL missing, log once and skip.
     - If interval is invalid, clamp to defaults.
   - Avoid sync if no new captures since `lastSyncAt`.

## Notes / UX
- Timed sync only works while an X/Twitter tab is open (userscript scope).
- If HomeTimelineModule is disabled, show guidance in settings (or disable the toggle).
- Keep manual sync button as a visible “run now” escape hatch.
